pipeline {
    agent any

    environment {
        // Database connection details
        DB_URL = 'jdbc:postgresql://postgres:5432/aspira'
        DB_USER = 'firefly_dev_developer'
        DB_PASSWORD = 'Postgres2024!'
        // Liquibase changelog file
        CHANGELOG_FILE = 'init_webtools.sql'
        // Define Liquibase executable
        LIQUIBASE_HOME = tool 'liquibase'
        LIQUIBASE_CMD = "${LIQUIBASE_HOME}/liquibase"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/deniscitadin/liquibase-jenkins-example.git'
            }
        }

        stage('Build and Migrate Database') {
            steps {
                script {
                    // Change to the directory where the Liquibase binary is located
                    dir("${LIQUIBASE_HOME}") {
                        // Liquibase update command
                        sh """
                            ${LIQUIBASE_CMD} \\
                            --url=${DB_URL} \\
                            --username=${DB_USER} \\
                            --password=${DB_PASSWORD} \\
                            --searchPath="/var/jenkins_home/workspace/liquibase/" \\
                            --changeLogFile=${CHANGELOG_FILE} update \\
                            --defaultSchemaName=webtools
                        """
                    }
                }
            }
        }
    }
}
